---
layout: default
---

<style scoped>
.slidev-vclick-hidden {
  display: none;
}
.small-code-json {
  .slidev-code {
    font-size: 0.7rem !important;
    line-height: 0rem !important;
    width: 400px !important;
  }
}

.small-code-ts {
  .slidev-code {
    font-size: 0.75rem !important;
    line-height: 0rem !important;
  }
}
</style>

<div class="_bullet">

2. それぞれのケースのコードの AST を見ながら、ルールを実装する

<div v-click="[0]">

* AST Explorer (https://ast-explorer.dev/) で AST を確認

</div>

</div>

<div class="flex justify-around small-code-json" v-click="[1]">

```json{*}
// ✅ 正常系
{
  "type": "Program",
  "body": [
    {
      "type": "IfStatement",
      "test": {
        "type": "Literal",
        "value": true,
        "raw": "true"
      },
      "consequent": {
        "type": "BlockStatement",
        "body": [
          {
            "type": "ExpressionStatement",
            "expression": {
              // ...
            }
          }
        ]
      }
    }
  ]
}
```

<div>

```json{*}
// ❌ 異常系
{
  "type": "Program",
  "body": [
    {
      "type": "IfStatement",
      "test": {
        "type": "Literal",
        "value": true,
        "raw": "true"
      },
      "consequent": {
        "type": "ExpressionStatement",
        "expression": {
          // ...
        }
      }
    }
  ]
}
```

</div>

</div>

<div class="flex justify-around small-code-json" v-click="[2]">

```json{12-22}
// ✅ 正常系
{
  "type": "Program",
  "body": [
    {
      "type": "IfStatement",
      "test": {
        "type": "Literal",
        "value": true,
        "raw": "true"
      },
      "consequent": {
        "type": "BlockStatement",
        "body": [
          {
            "type": "ExpressionStatement",
            "expression": {
              // ...
            }
          }
        ]
      }
    }
  ]
}
```

<div>

```json{12-17}
// ❌ 異常系
{
  "type": "Program",
  "body": [
    {
      "type": "IfStatement",
      "test": {
        "type": "Literal",
        "value": true,
        "raw": "true"
      },
      "consequent": {
        "type": "ExpressionStatement",
        "expression": {
          // ...
        }
      }
    }
  ]
}
```

</div>

</div>

<div class="_bullet" v-click="3">

* ルール定義: `IfStatement`の consequent が`BlockStatement`でない場合はエラーにする

</div>

<div v-click="[4]" class="small-code-ts">

```ts
import { Rule } from "eslint";

export const requireIfBlock: Rule.RuleModule = {
  meta: {
    type: "problem",
    messages: {
      requireIfBlock: "if文にブロックを使用してください",
    },
  },
  create(context) {
    return {
      IfStatement(node) {
        if (node.consequent.type !== "BlockStatement") {
          context.report({
            node,
            messageId: "requireIfBlock",
          });
        }
      },
    };
  },
};
```

</div>

<div v-click="5">

```ts{*}
import { Rule } from "eslint";

export const requireIfBlock: Rule.RuleModule = {
  meta: { /** ... */ },
  create(context) {
    return {
      IfStatement(node) {
        if (node.consequent.type !== "BlockStatement") {
          context.report({
            node,
            messageId: "requireIfBlock",
          });
        }
      },
    };
  },
};
```

</div>

<!-- 
コードの AST を見る際には、 ast explorer というサイトが非常に便利です  
このセッションで紹介している AST はそのサイトで確認した AST を 非常に単純化にしたものを使用しております。  
こちらがその AST の内容です。

[click] 正常としたいコードの AST と、異常としたいコードの AST を比較してみると、`IfStatement`のノードのプロパティである`consequent`の中身に違いがあることが確認できます。  
[click] 正常としたい AST の方では、`consequent`の type が`BlockStatement`であるのに対し、異常としたい AST の方は、`ExpressionStatement`となっています。

[click] これを元に自然言語でルールを定義すると、「`IfStatement`の consequent が`BlockStatement`でない場合はエラーにする」というようになります。  
これを実際にコードに落すと、こちらのようになります。 

[click] meta の部分は今回あまり重要ではないので、`create`メソッドにフォーカスを当ててみます

[click] 今回定義するルールは、If 文のノードに対する操作を行いたいので、`create`メソッドの`return`に`IfStatement`を指定しています。  
これにより、eslint が `IfStatement` のノードを探索する際に、記述した処理が実行されます。

そして、定義した通り、consequent の type が `BlockStatement` でない場合はエラーにします。

ルールの実装は、これで終わりです。  
JavaScript コードを対象とした ESLint のルール実装は、このように、ほとんどの場合で AST に沿って実装していく作業になります。

さて、ここまでで、ルールの実装が完了しましたので、
-->